<div class="container-fluid mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- En-tête -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="h3 mb-1">{{ isEdit ? 'Modifier un partenaire' : 'Ajouter un partenaire' }}</h2>
          <p class="text-muted mb-0">
            {{ isEdit ? 'Modifiez les informations du partenaire' : 'Créez un nouveau compte partenaire PNVB' }}
          </p>
        </div>
        <button class="btn btn-outline-secondary" [routerLink]="['/features/admin/partenaires']">
          <i class="fas fa-arrow-left me-2"></i>Retour
        </button>
      </div>

      <!-- Formulaire -->
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <form [formGroup]="partenaireForm" (ngSubmit)="onSubmit()" novalidate>
            
            <!-- Informations de base -->
            <h5 class="mb-3 text-primary">Informations de la structure</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Nom de la structure <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="nomStructure" 
                         [class.is-invalid]="nomStructure?.invalid && nomStructure?.touched"
                         placeholder="Nom officiel de la structure">
                  <div *ngIf="nomStructure?.invalid && nomStructure?.touched" class="invalid-feedback">
                    <div *ngIf="nomStructure?.errors?.['required']">Le nom de la structure est obligatoire</div>
                    <div *ngIf="nomStructure?.errors?.['minlength']">Le nom doit faire au moins 2 caractères</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Types de structure multiples -->
            <div class="mb-4">
              <label class="form-label fw-semibold">Types de structure <span class="text-danger">*</span></label>
              
              <!-- Liste des types sélectionnés -->
              <div formArrayName="typeStructures" class="mb-3">
                <div *ngFor="let typeControl of typeStructuresArray.controls; let i = index" 
                     class="input-group mb-2">
                  <select class="form-select" [formControlName]="i"
                          (change)="onTypeStructureChange($event, i)"
                          [class.is-invalid]="typeStructuresArray.invalid && typeStructuresArray.touched">
                    <option value="">Sélectionnez un type...</option>
                    <option *ngFor="let type of typesStructure" 
                            [value]="type.value"
                            [disabled]="isTypeSelected(type.value) && typeControl.value !== type.value">
                      {{ type.label }}
                    </option>
                  </select>
                  <button *ngIf="typeStructuresArray.length > 1" 
                          class="btn btn-outline-danger" 
                          type="button" 
                          (click)="removeTypeStructure(i)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>

              <!-- Bouton pour ajouter un autre type -->
              <button *ngIf="getAvailableTypes().length > 0" 
                      class="btn btn-outline-primary btn-sm" 
                      type="button"
                      (click)="addTypeStructure()">
                <i class="fas fa-plus me-1"></i>Ajouter un autre type
              </button>

              <div *ngIf="typeStructuresArray.invalid && typeStructuresArray.touched" class="invalid-feedback d-block">
                Au moins un type de structure est obligatoire
              </div>

              <!-- Aperçu des types sélectionnés -->
              <div *ngIf="typeStructuresArray.length > 0" class="mt-2">
                <small class="text-muted">Types sélectionnés :</small>
                <div class="d-flex flex-wrap gap-1 mt-1">
                  <span *ngFor="let typeControl of typeStructuresArray.controls" 
                        class="badge bg-primary">
                    {{ getTypeLabel(typeControl.value) }}
                    <i *ngIf="typeControl.value === 'PTF'" class="fas fa-hand-holding-usd ms-1"></i>
                  </span>
                </div>
              </div>
            </div>

            <!-- Domaine d'activité -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Domaine d'activité principal <span class="text-danger">*</span></label>
                  <select class="form-select" formControlName="domaineActivite"
                          [class.is-invalid]="domaineActivite?.invalid && domaineActivite?.touched">
                    <option *ngFor="let domaine of domainesActivite" [value]="domaine">
                      {{ domaine }}
                    </option>
                  </select>
                  <div *ngIf="domaineActivite?.invalid && domaineActivite?.touched" class="invalid-feedback">
                    Le domaine d'activité est obligatoire
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Site web</label>
                  <input type="url" class="form-control" formControlName="siteWeb"
                         placeholder="https://www.exemple.com">
                </div>
              </div>
            </div>

            <!-- Personne contact -->
            <h5 class="mb-3 mt-4 text-primary">Personne contact</h5>
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Nom du contact <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="personneContactNom"
                         [class.is-invalid]="personneContactNom?.invalid && personneContactNom?.touched"
                         placeholder="Nom et prénom">
                  <div *ngIf="personneContactNom?.invalid && personneContactNom?.touched" class="invalid-feedback">
                    Le nom du contact est obligatoire
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Email du contact <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" formControlName="personneContactEmail"
                         [class.is-invalid]="personneContactEmail?.invalid && personneContactEmail?.touched"
                         placeholder="contact@exemple.com">
                  <div *ngIf="personneContactEmail?.invalid && personneContactEmail?.touched" class="invalid-feedback">
                    <div *ngIf="personneContactEmail?.errors?.['required']">L'email du contact est obligatoire</div>
                    <div *ngIf="personneContactEmail?.errors?.['email']">Format d'email invalide</div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Téléphone du contact <span class="text-danger">*</span></label>
                  <input type="tel" class="form-control" formControlName="personneContactTelephone"
                         [class.is-invalid]="personneContactTelephone?.invalid && personneContactTelephone?.touched"
                         placeholder="+226 XX XX XX XX">
                  <div *ngIf="personneContactTelephone?.invalid && personneContactTelephone?.touched" class="invalid-feedback">
                    Le téléphone du contact est obligatoire
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Fonction du contact <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="personneContactFonction"
                         [class.is-invalid]="personneContactFonction?.invalid && personneContactFonction?.touched"
                         placeholder="Ex: Chargé de mission, Directeur...">
                  <div *ngIf="personneContactFonction?.invalid && personneContactFonction?.touched" class="invalid-feedback">
                    La fonction du contact est obligatoire
                  </div>
                </div>
              </div>
            </div>

            <!-- Coordonnées -->
            <h5 class="mb-3 mt-4 text-primary">Coordonnées de la structure</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Email de la structure <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" formControlName="email"
                         [class.is-invalid]="email?.invalid && email?.touched"
                         placeholder="structure@exemple.com">
                  <div *ngIf="email?.invalid && email?.touched" class="invalid-feedback">
                    <div *ngIf="email?.errors?.['required']">L'email est obligatoire</div>
                    <div *ngIf="email?.errors?.['email']">Format d'email invalide</div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Téléphone de la structure <span class="text-danger">*</span></label>
                  <input type="tel" class="form-control" formControlName="telephone"
                         [class.is-invalid]="telephone?.invalid && telephone?.touched"
                         placeholder="+226 XX XX XX XX">
                  <div *ngIf="telephone?.invalid && telephone?.touched" class="invalid-feedback">
                    Le téléphone de la structure est obligatoire
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Adresse complète <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="adresse"
                         [class.is-invalid]="adresse?.invalid && adresse?.touched"
                         placeholder="Adresse complète (rue, ville, pays)">
                  <div *ngIf="adresse?.invalid && adresse?.touched" class="invalid-feedback">
                    L'adresse est obligatoire
                  </div>
                </div>
              </div>
            </div>

            <!-- Mot de passe temporaire (création seulement) -->
            <div *ngIf="!isEdit" class="mb-4">
              <h5 class="mb-3 text-primary">Accès à la plateforme</h5>
              <label class="form-label fw-semibold">Mot de passe temporaire <span class="text-danger">*</span></label>
              <div class="input-group">
                <input [type]="showPassword ? 'text' : 'password'" class="form-control" 
                       formControlName="motDePasseTemporaire"
                       [class.is-invalid]="motDePasseTemporaire?.invalid && motDePasseTemporaire?.touched"
                       readonly>
                <button class="btn btn-outline-secondary" type="button" (click)="togglePasswordVisibility()">
                  <i class="fas" [class.fa-eye]="!showPassword" [class.fa-eye-slash]="showPassword"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" (click)="copyPassword()">
                  <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" (click)="generateTemporaryPassword()">
                  <i class="fas fa-redo"></i>
                </button>
              </div>
              <div class="form-text">
                <i class="fas fa-info-circle text-warning me-1"></i>
                Copiez ce mot de passe et envoyez-le manuellement au partenaire. Il devra le changer à sa première connexion.
              </div>
              <div *ngIf="motDePasseTemporaire?.invalid && motDePasseTemporaire?.touched" class="invalid-feedback d-block">
                Le mot de passe temporaire est obligatoire
              </div>
            </div>

            <!-- Description -->
            <div class="mb-3">
              <h5 class="mb-3 text-primary">Description</h5>
              <label class="form-label fw-semibold">Description de la structure <span class="text-danger">*</span></label>
              <textarea class="form-control" formControlName="description" rows="4"
                        [class.is-invalid]="description?.invalid && description?.touched"
                        placeholder="Description de la structure, missions principales, objectifs..."></textarea>
              <div *ngIf="description?.invalid && description?.touched" class="invalid-feedback">
                La description est obligatoire
              </div>
            </div>

            <!-- Statut du compte -->
            <div class="mb-4">
              <h5 class="mb-3 text-primary">Statut du compte</h5>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" formControlName="estActive">
                <label class="form-check-label fw-semibold">Compte activé</label>
              </div>
              <div class="form-text">
                Le partenaire pourra se connecter et utiliser la plateforme uniquement si le compte est activé.
                <span class="text-warning">Recommandé : désactiver le compte lors de la création et l'activer après validation.</span>
              </div>
            </div>

            <!-- Informations sur les permissions -->
            <div class="alert alert-info">
              <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Permissions automatiques</h6>
              <p class="mb-0">
                Les permissions (création de projets, gestion des volontaires, etc.) sont automatiquement définies 
                selon le type de structure sélectionné. Les PTF ne peuvent pas créer de projets mais ont accès aux statistiques.
              </p>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-between pt-3 border-top">
              <button type="button" class="btn btn-outline-secondary" 
                      [routerLink]="['/features/admin/partenaires']">
                <i class="fas fa-times me-2"></i>Annuler
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="partenaireForm.invalid">
                <i class="fas fa-save me-2"></i>
                {{ isEdit ? 'Modifier le partenaire' : 'Créer le partenaire' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
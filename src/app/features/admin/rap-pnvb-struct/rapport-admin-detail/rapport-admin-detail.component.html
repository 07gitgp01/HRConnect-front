<div class="container-fluid py-4">
  <!-- En-tête avec navigation -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary me-3" (click)="goBack()">
          <i class="bi bi-arrow-left"></i> Retour à la liste
        </button>
        <h1 class="h3 mb-0">
          <i class="bi bi-shield-check me-2"></i>Administration - Rapport détail
        </h1>
      </div>
    </div>
  </div>

  <!-- Messages d'alerte -->
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
    <i class="bi bi-check-circle me-2"></i>
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = ''"></button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
  </div>

  <!-- Loading state -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-3">Chargement du rapport...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !isLoading" class="alert alert-danger">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{error}}
    <button class="btn btn-outline-secondary btn-sm ms-3" (click)="goBack()">Retour</button>
  </div>

  <!-- Contenu du rapport -->
  <div *ngIf="!isLoading && !error && rapport" class="row">
    <!-- Colonne principale -->
    <div class="col-lg-8">
      <!-- En-tête du rapport avec actions -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h2 class="h4 mb-2">
                Rapport d'évaluation
                <span class="badge ms-2" [class]="getStatutClass(rapport.statut)">
                  <i class="bi me-1" [class]="'bi-' + getStatutIcon(rapport.statut)"></i>
                  {{rapport.statut}}
                </span>
              </h2>
              
              <div class="d-flex align-items-center text-muted mb-3">
                <div class="me-4">
                  <i class="bi bi-calendar me-1"></i>
                  {{rapport.dateSoumission | date:'dd/MM/yyyy à HH:mm'}}
                </div>
                <div>
                  <i class="bi bi-hash me-1"></i>
                  ID: <code class="cursor-pointer" (click)="copyRapportId()">{{rapport.id}}</code>
                </div>
              </div>
            </div>
            
            <div class="btn-group" *ngIf="rapport.statut !== 'Validé' && rapport.statut !== 'Rejeté'">
              <button class="btn btn-success" (click)="validerRapport()" [disabled]="isSubmitting">
                <i class="bi bi-check-lg me-2"></i>
                {{isSubmitting ? 'Validation...' : 'Valider'}}
              </button>
              <button class="btn btn-danger" (click)="rejeterRapport()" [disabled]="isSubmitting">
                <i class="bi bi-x-lg me-2"></i>
                Rejeter
              </button>
              <button class="btn btn-info" (click)="marquerCommeLu()" 
                      *ngIf="rapport.statut !== 'Lu par PNVB'">
                <i class="bi bi-eye me-2"></i>
                Marquer lu
              </button>
            </div>
            
            <div class="btn-group" *ngIf="rapport.statut === 'Validé' || rapport.statut === 'Rejeté'">
              <button class="btn btn-outline-primary" (click)="toggleFeedbackForm()">
                <i class="bi bi-chat-left-text me-2"></i>
                Modifier feedback
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Informations générales -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>Informations générales
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted mb-3">Volontaire</h6>
              <div class="d-flex align-items-center mb-3">
                <div class="avatar-lg bg-light rounded-circle d-flex align-items-center justify-content-center me-3">
                  <i class="bi bi-person fs-3 text-primary"></i>
                </div>
                <div>
                  <h4 class="mb-0">{{rapport.volontaireNomComplet}}</h4>
                  <p class="text-muted mb-1">{{rapport.missionVolontaire}}</p>
                  <button class="btn btn-sm btn-outline-primary" (click)="goToVolontaire()">
                    <i class="bi bi-person me-1"></i>Voir le volontaire
                  </button>
                </div>
              </div>
              
              <dl>
                <dt>ID Volontaire</dt>
                <dd><code>{{rapport.volontaireId}}</code></dd>
                
                <dt>Période d'évaluation</dt>
                <dd>
                  <span class="badge bg-info fs-6">{{rapport.periode}}</span>
                </dd>
              </dl>
            </div>
            
            <div class="col-md-6">
              <h6 class="text-muted mb-3">Partenaire</h6>
              <div class="d-flex align-items-center mb-3">
                <div class="avatar-lg bg-light rounded-circle d-flex align-items-center justify-content-center me-3">
                  <i class="bi bi-building fs-3 text-success"></i>
                </div>
                <div>
                  <h4 class="mb-0">{{rapport.partenaireNom}}</h4>
                  <p class="text-muted mb-1">Partenaire ID: {{rapport.partenaireId}}</p>
                  <button class="btn btn-sm btn-outline-success" (click)="goToPartenaire()">
                    <i class="bi bi-building me-1"></i>Voir le partenaire
                  </button>
                </div>
              </div>
              
              <dl>
                <dt>Date de soumission</dt>
                <dd>{{formatDate(rapport.dateSoumission)}}</dd>
                
                <dt>Dernière modification</dt>
                <dd>{{formatDate(rapport.updated_at || rapport.dateModification || rapport.dateSoumission)}}</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <!-- Évaluation -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-graph-up me-2"></i>Évaluation
          </h5>
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-4 text-center">
              <div class="display-1 fw-bold mb-3" [class]="getEvaluationColor(rapport.evaluationGlobale)">
                {{rapport.evaluationGlobale}}/10
              </div>
              <div class="h4 text-muted">{{evaluationLabel}}</div>
              <div class="mt-3">
                <i *ngFor="let star of getStarIcons(rapport.evaluationGlobale / 2, 5)" 
                   class="bi mx-1 fs-4" [class]="star"></i>
              </div>
            </div>
            
            <div class="col-md-8">
              <h6>Critères détaillés</h6>
              <div *ngIf="rapport.criteres">
                <div class="mb-3" *ngFor="let critere of getCriteresList()">
                  <div class="d-flex justify-content-between mb-1">
                    <span>{{critere.label}}</span>
                    <span>{{critere.score}}/5</span>
                  </div>
                  <div class="progress" style="height: 10px;">
                    <div class="progress-bar" 
                         [ngClass]="getProgressBarClass(critere.score)"
                         [style.width.%]="getProgressBarWidth(critere.score)">
                    </div>
                  </div>
                  <small class="text-muted">{{critere.description}}</small>
                </div>
                
                <hr>
                <div class="d-flex justify-content-between">
                  <strong>Moyenne des critères</strong>
                  <strong>{{moyenneCriteres.toFixed(1)}}/5</strong>
                </div>
              </div>
              
              <div *ngIf="!rapport.criteres" class="text-center text-muted py-4">
                <i class="bi bi-info-circle display-6 d-block mb-3"></i>
                Aucun critère détaillé disponible
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Commentaires du partenaire -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-chat-text me-2"></i>Commentaires du partenaire
          </h5>
        </div>
        <div class="card-body">
          <div class="white-space-pre">{{rapport.commentaires}}</div>
        </div>
      </div>

      <!-- Feedback PNVB -->
      <div class="card mb-4">
        <div class="card-header" 
             [ngClass]="{
               'bg-success text-white': rapport.statut === 'Validé',
               'bg-danger text-white': rapport.statut === 'Rejeté',
               'bg-info text-white': rapport.statut === 'Lu par PNVB',
               'bg-light': !rapport.feedbackPNVB
             }">
          <h5 class="mb-0">
            <i class="bi bi-shield-check me-2"></i>Feedback PNVB
            <span *ngIf="rapport.validePar" class="ms-2 small">
              par {{rapport.validePar}}
            </span>
          </h5>
        </div>
        <div class="card-body">
          <div *ngIf="rapport.feedbackPNVB">
            <div class="d-flex mb-3">
              <div class="flex-shrink-0">
                <i class="bi bi-person-badge fs-3" 
                   [ngClass]="{
                     'text-success': rapport.statut === 'Validé',
                     'text-danger': rapport.statut === 'Rejeté',
                     'text-info': rapport.statut === 'Lu par PNVB'
                   }"></i>
              </div>
              <div class="ms-3">
                <h6 class="mb-1">
                  {{rapport.statut === 'Validé' ? 'Validé' : 
                    rapport.statut === 'Rejeté' ? 'Rejeté' : 
                    'Marqué comme lu'}}
                  <span *ngIf="rapport.dateValidation">
                    le {{formatDate(rapport.dateValidation)}}
                  </span>
                </h6>
                <small class="text-muted" *ngIf="rapport.validePar">
                  Par {{rapport.validePar}}
                </small>
              </div>
            </div>
            
            <div class="alert" 
                 [ngClass]="{
                   'alert-success': rapport.statut === 'Validé',
                   'alert-danger': rapport.statut === 'Rejeté',
                   'alert-info': rapport.statut === 'Lu par PNVB'
                 }">
              {{rapport.feedbackPNVB}}
            </div>
          </div>
          
          <div *ngIf="!rapport.feedbackPNVB" class="text-center text-muted py-4">
            <i class="bi bi-chat-left-text display-6 d-block mb-3"></i>
            <p class="mb-0">Aucun feedback PNVB pour le moment</p>
            <button class="btn btn-outline-primary mt-3" (click)="toggleFeedbackForm()">
              <i class="bi bi-plus-circle me-2"></i>Ajouter un feedback
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Colonne latérale -->
    <div class="col-lg-4">
      <!-- Formulaire de feedback PNVB -->
      <div class="card mb-4" *ngIf="showFeedbackForm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-chat-left-text me-2"></i>Feedback PNVB
          </h5>
        </div>
        <div class="card-body">
          <form [formGroup]="feedbackForm" (ngSubmit)="soumettreFeedback()">
            <div class="mb-3">
              <label class="form-label">Action</label>
              <select class="form-select" formControlName="action">
                <option value="validation">Valider le rapport</option>
                <option value="rejet">Rejeter le rapport</option>
                <option value="commentaire">Commenter seulement</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Commentaire</label>
              <textarea class="form-control" rows="6" formControlName="commentaire"
                        placeholder="Donnez votre feedback au partenaire..."></textarea>
              <div class="form-text">
                Ce commentaire sera visible par le partenaire
              </div>
            </div>
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary" 
                      [disabled]="feedbackForm.invalid || isSubmitting">
                <i class="bi bi-send me-2"></i>
                {{isSubmitting ? 'Envoi en cours...' : 'Envoyer le feedback'}}
              </button>
              <button type="button" class="btn btn-outline-secondary" 
                      (click)="toggleFeedbackForm()">
                Annuler
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Document annexe -->
      <div class="card mb-4" *ngIf="rapport.urlDocumentAnnexe">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-paperclip me-2"></i>Document annexe
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <i class="bi bi-file-earmark-text fs-3 text-primary me-3"></i>
            <div>
              <div class="fw-bold">{{rapport.nomDocumentAnnexe || 'Document joint'}}</div>
              <small class="text-muted">Document fourni par le partenaire</small>
            </div>
          </div>
          <div class="d-grid">
            <button class="btn btn-outline-primary" (click)="downloadDocument()">
              <i class="bi bi-download me-2"></i>Télécharger
            </button>
          </div>
        </div>
      </div>

      <!-- Métadonnées -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-gear me-2"></i>Métadonnées
          </h5>
        </div>
        <div class="card-body">
          <dl class="mb-0">
            <dt>ID Rapport</dt>
            <dd><code>{{rapport.id}}</code></dd>
            
            <dt>Statut</dt>
            <dd>
              <span class="badge" [class]="getStatutClass(rapport.statut)">
                {{rapport.statut}}
              </span>
            </dd>
            
            <dt>Créé le</dt>
            <dd>{{formatDate(rapport.created_at || rapport.dateSoumission)}}</dd>
            
            <dt>Modifié le</dt>
            <dd>{{formatDate(rapport.updated_at || rapport.dateModification || rapport.dateSoumission)}}</dd>
            
            <dt *ngIf="rapport.dateValidation">Validé/Rejeté le</dt>
            <dd *ngIf="rapport.dateValidation">{{formatDate(rapport.dateValidation)}}</dd>
            
            <dt *ngIf="rapport.validePar">Validé/Rejeté par</dt>
            <dd *ngIf="rapport.validePar">{{rapport.validePar}}</dd>
          </dl>
        </div>
      </div>

      <!-- Historique des modifications -->
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-clock-history me-2"></i>Historique
            <span class="badge bg-secondary ms-2">{{historique.length}}</span>
          </h5>
          <button class="btn btn-sm btn-outline-secondary" (click)="toggleHistorique()">
            <i class="bi" [class]="showHistorique ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </button>
        </div>
        
        <div class="card-body" *ngIf="showHistorique">
          <div *ngIf="historique.length > 0" class="timeline">
            <div *ngFor="let event of historique" class="timeline-item mb-3">
              <div class="d-flex">
                <div class="flex-shrink-0">
                  <span class="badge rounded-circle p-2" 
                        [ngClass]="'bg-' + getActionColor(event.action)">
                    <i class="bi" [class]="'bi-' + getActionIcon(event.action)"></i>
                  </span>
                </div>
                <div class="flex-grow-1 ms-3">
                  <h6 class="mb-1">{{event.description}}</h6>
                  <small class="text-muted">
                    {{formatDate(event.date)}}
                    <span *ngIf="event.utilisateur">par {{event.utilisateur}}</span>
                  </small>
                  <p *ngIf="event.details" class="mb-0 small text-muted mt-1">
                    {{event.details}}
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <div *ngIf="historique.length === 0" class="text-center text-muted py-3">
            <i class="bi bi-clock-history display-6 d-block mb-2"></i>
            <p class="mb-0">Aucun historique disponible</p>
          </div>
          
          <button class="btn btn-outline-primary btn-sm w-100 mt-2" (click)="loadHistorique(rapport.id!.toString())">
            <i class="bi bi-arrow-clockwise me-2"></i>Actualiser l'historique
          </button>
        </div>
      </div>
    </div>
  </div>
</div>